<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Admin Balmon | Drive Integration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/css/adminlte.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>

<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
  <div class="app-wrapper">

    <nav class="app-header navbar navbar-expand bg-body">
      <div class="container-fluid">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" data-lte-toggle="sidebar" href="#"><i class="bi bi-list"></i></a></li>
          <li class="nav-item"><span class="nav-link fw-bold">Arsip (Google Drive + Firebase)</span></li>
        </ul>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item">
                <button id="authorize_button" class="btn btn-outline-danger btn-sm" style="display: none;">
                    <i class="bi bi-google"></i> Login Google Drive
                </button>
                <button id="signout_button" class="btn btn-outline-secondary btn-sm" style="display: none;">
                    <i class="bi bi-box-arrow-right"></i> Logout Drive
                </button>
            </li>
        </ul>
      </div>
    </nav>

    <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
      <div class="sidebar-brand">
        <a href="#" class="brand-link">
          <span class="brand-text fw-light ms-2">Admin Balmon</span>
        </a>
      </div>
      <div class="sidebar-wrapper">
        <nav class="mt-2">
          <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview">
            <li class="nav-item"><a href="admin-balmon.html" class="nav-link"><i class="nav-icon bi bi-speedometer"></i><p>Dashboard</p></a></li>
            <li class="nav-item"><a href="dokumen.html" class="nav-link active"><i class="nav-icon bi bi-google"></i><p>Arsip Drive</p></a></li>
          </ul>
        </nav>
      </div>
    </aside>

    <main class="app-main">
      <div class="app-content-header">
        <div class="container-fluid">
          <div class="card shadow-sm border-0">
            <div class="card-header bg-success text-white">
              <h5 class="card-title mb-0"><i class="bi bi-google"></i> Upload ke Google Drive</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-info py-2" id="drive-status">
                <small><i class="bi bi-info-circle"></i> Silakan Login Google Drive di pojok kanan atas dulu.</small>
              </div>
              <div class="row g-3 align-items-end">
                <div class="col-md-5">
                  <label class="form-label">Judul Dokumen</label>
                  <input type="text" id="docJudul" class="form-control" placeholder="Judul Dokumen">
                </div>
                <div class="col-md-5">
                  <label class="form-label">File</label>
                  <input type="file" id="docFile" class="form-control">
                </div>
                <div class="col-md-2">
                  <button onclick="uploadToDrive()" id="btnUpload" class="btn btn-primary w-100" disabled>Upload</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="app-content">
        <div class="container-fluid">
          <div class="row mt-4" id="gridDokumen">
             </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/js/adminlte.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

  <script>
    // -----------------------------------------------------------------
    // 1. KONFIGURASI (GANTI BAGIAN INI DENGAN MILIK ANDA)
    // -----------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDUeIg9Zn_xndPXtChO8KufXFp6EMtqBJ0", // API Key Firebase
      authDomain: "admin-pelayanan-balmon.firebaseapp.com",
      databaseURL: "https://admin-pelayanan-balmon-default-rtdb.firebaseio.com",
      projectId: "admin-pelayanan-balmon",
      appId: "1:1071557110255:web:bff7087da1feacccb7ee1a"
    };

    // SETUP GOOGLE DRIVE API (Dari Google Cloud Console)
    const CLIENT_ID = '1053263347737-g32v5386cnfl8dbe49i0t9i9pv9fg44t.apps.googleusercontent.com'; 
    const API_KEY = 'AIzaSyAcIVdG6dQxewbNNlvRCWb0yGjCWoeqdE4'; 
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    // -----------------------------------------------------------------
    // 2. LOGIKA FIREBASE
    // -----------------------------------------------------------------
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // READ DATA (Sama seperti sebelumnya, tapi URL-nya dari Drive)
    db.ref('arsip_drive').on('value', snap => {
        const grid = document.getElementById('gridDokumen');
        grid.innerHTML = '';
        if(!snap.exists()) return;

        let docs = [];
        snap.forEach(c => docs.push({key: c.key, ...c.val()}));
        
        docs.reverse().forEach(d => {
            let icon = d.tipe.includes('pdf') ? 'bi-file-earmark-pdf text-danger' : 'bi-file-earmark-text text-primary';
            
            grid.innerHTML += `
                <div class="col-md-3 mb-3">
                    <div class="card h-100 shadow-sm text-center p-3">
                        <i class="bi ${icon} display-4"></i>
                        <h6 class="mt-2 text-truncate">${d.judul}</h6>
                        <div class="mt-2">
                            <a href="${d.url}" target="_blank" class="btn btn-sm btn-outline-primary">Buka</a>
                            <button onclick="hapus('${d.key}')" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                </div>
            `;
        });
    });

    function hapus(key) {
        if(confirm('Hapus link dokumen ini? (File di Drive harus dihapus manual)')) {
            db.ref(`arsip_drive/${key}`).remove();
        }
    }

    // -----------------------------------------------------------------
    // 3. LOGIKA GOOGLE DRIVE API (AUTH & UPLOAD)
    // -----------------------------------------------------------------
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    function gapiLoaded() {
        gapi.load('client', intializeGapiClient);
    }

    async function intializeGapiClient() {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapiInited = true;
        maybeEnableButtons();
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
    }

    function maybeEnableButtons() {
        if (gapiInited && gisInited) {
            document.getElementById('authorize_button').style.display = 'block';
        }
    }

    // HANDLER LOGIN
    document.getElementById('authorize_button').onclick = () => {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) throw (resp);
            document.getElementById('signout_button').style.display = 'block';
            document.getElementById('authorize_button').style.display = 'none';
            document.getElementById('btnUpload').disabled = false;
            document.getElementById('drive-status').innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> Terhubung ke Google Drive</small>';
        };
        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    };

    // HANDLER LOGOUT
    document.getElementById('signout_button').onclick = () => {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            document.getElementById('authorize_button').style.display = 'block';
            document.getElementById('signout_button').style.display = 'none';
            document.getElementById('btnUpload').disabled = true;
            document.getElementById('drive-status').innerHTML = '<small>Logout berhasil.</small>';
        }
    };

    // FUNGSI UPLOAD KE DRIVE
    async function uploadToDrive() {
        const fileInput = document.getElementById('docFile');
        const judul = document.getElementById('docJudul').value;
        const file = fileInput.files[0];

        if (!file || !judul) return Swal.fire('Error', 'Isi judul dan pilih file!', 'error');

        Swal.fire({title: 'Mengupload ke Drive...', didOpen: () => Swal.showLoading()});

        // Metadata File Drive
        const metadata = {
            'name': file.name,
            'mimeType': file.type || 'application/octet-stream'
        };

        // Form Data Multipart
        const accessToken = gapi.client.getToken().access_token;
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);

        try {
            // Upload via Fetch API agar lebih mudah menangani Multipart
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink,webContentLink', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            });
            const data = await response.json();

            if(data.error) throw new Error(data.error.message);

            console.log("File Uploaded to Drive:", data);

            // SIMPAN LINK KE FIREBASE
            await db.ref('arsip_drive').push({
                judul: judul,
                drive_id: data.id,
                url: data.webViewLink, // Link untuk melihat file
                tipe: file.type,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            Swal.fire('Sukses', 'File tersimpan di Drive & Database!', 'success');
            document.getElementById('docJudul').value = '';
            document.getElementById('docFile').value = '';

        } catch (error) {
            console.error(error);
            Swal.fire('Gagal', error.message, 'error');
        }
    }
  </script>
</body>
</html>