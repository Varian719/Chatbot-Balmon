<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Admin Balmon | Manajemen Arsip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/css/adminlte.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <style>
    /* Efek hover pada kartu dokumen */
    .card-doc { transition: transform 0.2s, box-shadow 0.2s; cursor: default; }
    .card-doc:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
    /* Styling scrollbar agar lebih rapi */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaa; }
  </style>
</head>

<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
  <div class="app-wrapper">

    <nav class="app-header navbar navbar-expand bg-body shadow-sm">
      <div class="container-fluid">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" data-lte-toggle="sidebar" href="#"><i class="bi bi-list"></i></a></li>
          <li class="nav-item"><span class="nav-link fw-bold text-primary">Panel Admin Arsip</span></li>
        </ul>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item">
                <button id="authorize_button" class="btn btn-primary btn-sm me-2 shadow-sm" style="display: none;">
                    <i class="bi bi-google"></i> Login Google Drive
                </button>
                <button id="signout_button" class="btn btn-outline-danger btn-sm shadow-sm" style="display: none;">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </li>
        </ul>
      </div>
    </nav>

    <aside class="app-sidebar bg-dark shadow" data-bs-theme="dark">
      <div class="sidebar-brand">
        <a href="#" class="brand-link text-center">
          <span class="brand-text fw-bold">BALMON SAMARINDA</span>
        </a>
      </div>
      <div class="sidebar-wrapper">
        <nav class="mt-2">
          <ul class="nav sidebar-menu flex-column">
            <li class="nav-item"><a href="#" class="nav-link"><i class="nav-icon bi bi-speedometer"></i><p>Dashboard</p></a></li>
            <li class="nav-item"><a href="#" class="nav-link active"><i class="nav-icon bi bi-folder-fill"></i><p>Arsip Digital</p></a></li>
            <li class="nav-item"><a href="index.html" target="_blank" class="nav-link"><i class="nav-icon bi bi-globe"></i><p>Lihat Website</p></a></li>
          </ul>
        </nav>
      </div>
    </aside>

    <main class="app-main">
      <div class="app-content-header">
        <div class="container-fluid">
          
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-gradient-primary text-white" style="background: linear-gradient(45deg, #006fb0, #00ace0);">
              <h5 class="card-title mb-0"><i class="bi bi-cloud-arrow-up-fill"></i> Upload Dokumen Baru</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-light border py-2 mb-3 d-flex align-items-center gap-2" id="drive-status">
                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                <small>Memeriksa status koneksi Google Drive...</small>
              </div>

              <div class="row g-3 align-items-end">
                <div class="col-md-5">
                  <label class="form-label fw-bold">Judul Dokumen</label>
                  <input type="text" id="docJudul" class="form-control" placeholder="Contoh: Surat Edaran No. 5 Tahun 2024">
                </div>
                <div class="col-md-5">
                  <label class="form-label fw-bold">Pilih File (PDF/Word)</label>
                  <input type="file" id="docFile" class="form-control" accept=".pdf,.doc,.docx">
                </div>
                <div class="col-md-2">
                  <button onclick="uploadToDrive()" id="btnUpload" class="btn btn-primary w-100 fw-bold" disabled>
                    <i class="bi bi-upload"></i> UPLOAD
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
            <h5 class="text-secondary m-0"><i class="bi bi-database-check"></i> Arsip Tersimpan</h5>
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                <input type="text" id="searchBox" class="form-control border-start-0" placeholder="Cari judul dokumen...">
            </div>
          </div>

          <div class="row" id="gridDokumen">
             <div class="col-12 text-center py-5">
                 <div class="spinner-border text-primary" role="status"></div>
                 <p class="mt-2 text-muted">Mengambil data dari Firebase...</p>
             </div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/js/adminlte.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

  <script>
    // ============================================================
    // 1. KONFIGURASI (JANGAN UBAH ID FOLDER INI)
    // ============================================================
    const TARGET_FOLDER_ID = '1EUgbh4L8nh9J8X2EDc1s0KhnrqQGQmzL'; // ID Folder Anda
    
    const firebaseConfig = {
      apiKey: "AIzaSyDUeIg9Zn_xndPXtChO8KufXFp6EMtqBJ0",
      authDomain: "admin-pelayanan-balmon.firebaseapp.com",
      databaseURL: "https://admin-pelayanan-balmon-default-rtdb.firebaseio.com",
      projectId: "admin-pelayanan-balmon",
      appId: "1:1071557110255:web:bff7087da1feacccb7ee1a"
    };

    const CLIENT_ID = '1053263347737-g32v5386cnfl8dbe49i0t9i9pv9fg44t.apps.googleusercontent.com'; 
    const API_KEY = 'AIzaSyAcIVdG6dQxewbNNlvRCWb0yGjCWoeqdE4'; 
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    // Inisialisasi Firebase
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let allDocs = []; // Menyimpan data lokal untuk pencarian

    // ============================================================
    // 2. LOGIKA FIREBASE (TAMPILKAN & CARI DATA)
    // ============================================================
    
    // Ambil Data Realtime
    db.ref('arsip_drive').on('value', snap => {
        const grid = document.getElementById('gridDokumen');
        
        if(!snap.exists()) {
            allDocs = [];
            renderGrid(allDocs);
            return;
        }

        allDocs = [];
        snap.forEach(child => { allDocs.push({ key: child.key, ...child.val() }); });
        
        // Urutkan Terbaru di Atas
        allDocs.sort((a, b) => b.timestamp - a.timestamp);
        
        renderGrid(allDocs);
    });

    // Fungsi Render ke HTML
    function renderGrid(dataList) {
        const grid = document.getElementById('gridDokumen');
        if(dataList.length === 0) {
            grid.innerHTML = `<div class="col-12 text-center text-muted py-5"><i class="bi bi-folder-x display-1 opacity-25"></i><p class="mt-3">Tidak ada dokumen ditemukan.</p></div>`;
            return;
        }

        let html = '';
        dataList.forEach(d => {
            // Deteksi Tipe File untuk Ikon
            let isPdf = d.tipe && d.tipe.toLowerCase().includes('pdf');
            let iconClass = isPdf ? 'bi-file-earmark-pdf-fill text-danger' : 'bi-file-earmark-word-fill text-primary';
            let dateStr = new Date(d.timestamp).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});

            html += `
                <div class="col-md-4 col-lg-3 mb-4">
                    <div class="card h-100 border-0 shadow-sm card-doc">
                        <div class="card-body text-center d-flex flex-column">
                            <div class="mb-3">
                                <i class="bi ${iconClass}" style="font-size: 3rem;"></i>
                            </div>
                            <h6 class="fw-bold text-dark text-truncate px-2" title="${d.judul}">${d.judul}</h6>
                            <small class="text-muted mb-3"><i class="bi bi-calendar3"></i> ${dateStr}</small>
                            
                            <div class="mt-auto d-flex gap-2 justify-content-center">
                                <a href="https://drive.google.com/uc?export=view&id=${d.drive_id}" target="_blank" class="btn btn-sm btn-light border" title="Lihat">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <button onclick="hapusData('${d.key}')" class="btn btn-sm btn-outline-danger" title="Hapus">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
        grid.innerHTML = html;
    }

    // Event Listener Pencarian
    document.getElementById('searchBox').addEventListener('keyup', (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allDocs.filter(doc => doc.judul.toLowerCase().includes(keyword));
        renderGrid(filtered);
    });

    // Fungsi Hapus Data
    function hapusData(key) {
        Swal.fire({
            title: 'Hapus Arsip?',
            text: "Link akan dihapus dari aplikasi. File asli di Google Drive TIDAK otomatis terhapus (harus dihapus manual jika perlu).",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonText: 'Batal',
            confirmButtonText: 'Ya, Hapus!'
        }).then((result) => {
            if (result.isConfirmed) {
                db.ref(`arsip_drive/${key}`).remove();
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'success', title: 'Data berhasil dihapus' });
            }
        });
    }

    // ============================================================
    // 3. LOGIKA GOOGLE DRIVE (AUTH & UPLOAD)
    // ============================================================
    let tokenClient;
    let gapiInited = false, gisInited = false;

    function gapiLoaded() { gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapiInited = true; checkAuth();
    });}
    
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES, callback: '',
        });
        gisInited = true; checkAuth();
    }

    function checkAuth() {
        if (gapiInited && gisInited) {
            // Default state: Minta login
            updateUI(false);
        }
    }

    // Tombol Login
    document.getElementById('authorize_button').onclick = () => {
        tokenClient.callback = async (resp) => {
            if (resp.error) throw (resp);
            updateUI(true);
        };
        tokenClient.requestAccessToken({prompt: 'consent'});
    };

    // Tombol Logout
    document.getElementById('signout_button').onclick = () => {
        const token = gapi.client.getToken();
        if (token) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            updateUI(false);
        }
    };

    function updateUI(isLoggedIn) {
        const btnLogin = document.getElementById('authorize_button');
        const btnLogout = document.getElementById('signout_button');
        const btnUpload = document.getElementById('btnUpload');
        const statusDiv = document.getElementById('drive-status');

        if(isLoggedIn) {
            btnLogin.style.display = 'none';
            btnLogout.style.display = 'block';
            btnUpload.disabled = false;
            statusDiv.className = 'alert alert-success border py-2 mb-3';
            statusDiv.innerHTML = '<small><i class="bi bi-check-circle-fill"></i> <b>Terkoneksi.</b> File akan disimpan ke folder Arsip Balmon.</small>';
        } else {
            btnLogin.style.display = 'block';
            btnLogout.style.display = 'none';
            btnUpload.disabled = true;
            statusDiv.className = 'alert alert-warning border py-2 mb-3';
            statusDiv.innerHTML = '<small><i class="bi bi-exclamation-triangle"></i> Silakan <b>Login Google Drive</b> untuk mengupload file.</small>';
        }
    }

    // ============================================================
    // 4. FUNGSI UPLOAD FILE KE FOLDER SPESIFIK
    // ============================================================
    async function uploadToDrive() {        const fileInput = document.getElementById('docFile');
        const judul = document.getElementById('docJudul').value;
        const file = fileInput.files[0];

        if (!file || !judul) {
            return Swal.fire({ title: 'Data Belum Lengkap', text: 'Mohon isi judul dan pilih file.', icon: 'warning' });
        }

        // Tampilkan Loading
        Swal.fire({
            title: 'Sedang Mengupload...',
            html: 'Mengirim file ke folder Google Drive...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const accessToken = gapi.client.getToken().access_token;
            
            // --- INTI UPLOAD ---
            const metadata = { 
                'name': file.name, 
                'mimeType': file.type,
                'parents': [TARGET_FOLDER_ID] // Mengarahkan ke Folder Anda
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            });
            
            const driveData = await response.json();
            if(driveData.error) throw new Error(driveData.error.message);

            // Simpan Metadata ke Firebase
            await db.ref('arsip_drive').push({
                judul: judul,
                drive_id: driveData.id,
                tipe: file.type,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Sukses
            Swal.fire('Berhasil Upload!', 'Dokumen sudah tersimpan dan dapat diakses publik.', 'success');
            
            // Reset Form
            document.getElementById('docJudul').value = '';
            document.getElementById('docFile').value = '';

        } catch (err) {
            console.error(err);
            Swal.fire('Gagal Upload', 'Terjadi kesalahan: ' + err.message, 'error');
        }
    }
  </script>
</body>
</html>