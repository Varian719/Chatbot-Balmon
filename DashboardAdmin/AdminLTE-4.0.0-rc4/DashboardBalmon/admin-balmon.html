<!doctype html>
<html lang="id">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Admin Balmon | Dashboard Pelayanan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/css/adminlte.min.css" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  </head>
  
  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
      
      <nav class="app-header navbar navbar-expand bg-body">
        <div class="container-fluid">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button"><i class="bi bi-list"></i></a>
            </li>
            <li class="nav-item d-none d-md-block"><span class="nav-link fw-bold">Sistem Admin Balmon</span></li>
          </ul>
        </div>
      </nav>

      <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
        <div class="sidebar-brand">
          <a href="#" class="brand-link">
            <img src="https://cdn-icons-png.flaticon.com/512/900/900782.png" alt="Logo" class="brand-image opacity-75 shadow" />
            <span class="brand-text fw-light">Admin Balmon</span>
          </a>
        </div>
        <div class="sidebar-wrapper">
          <nav class="mt-2">
            <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu" data-accordion="false">
              
              <li class="nav-header">OPERASIONAL</li>
              <li class="nav-item">
                <a href="#" class="nav-link active">
                  <i class="nav-icon bi bi-speedometer"></i>
                  <p>Dashboard Utama</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-broadcast"></i>
                  <p>Data Frekuensi</p>
                </a>
              </li>
              
              <li class="nav-header">ADMINISTRASI</li>
              <li class="nav-item">
                <a href="dokumen.html" class="nav-link">
                  <i class="nav-icon bi bi-file-earmark-pdf"></i>
                  <p>Dokumen & SOP</p>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <main class="app-main">
        <div class="app-content-header">
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-6"><h3 class="mb-0">Dashboard Pelayanan</h3></div>
            </div>
          </div>
        </div>

        <div class="app-content">
          <div class="container-fluid">
            
            <div class="row">
              <div class="col-lg-3 col-6">
                <div class="small-box text-bg-primary">
                  <div class="inner">
                    <h3 id="stat-layanan">0</h3>
                    <p>Layanan Aktif</p>
                  </div>
                  <i class="small-box-icon bi bi-router-fill"></i>
                </div>
              </div>
              <div class="col-lg-3 col-6">
                <div class="small-box text-bg-warning">
                  <div class="inner">
                    <h3 id="stat-aduan">0</h3>
                    <p>Aduan Masuk</p>
                  </div>
                  <i class="small-box-icon bi bi-exclamation-triangle-fill"></i>
                </div>
              </div>
              <div class="col-lg-3 col-6">
                <div class="small-box text-bg-success">
                  <div class="inner">
                    <h3>0</h3>
                    <p>Aduan Selesai</p>
                  </div>
                  <i class="small-box-icon bi bi-check-circle-fill"></i>
                </div>
              </div>
            </div>

            <div class="row mt-3">
              
              <div class="col-lg-5">
                <div class="card card-primary card-outline mb-4">
                  <div class="card-header">
                    <h5 class="card-title">Update Info Layanan / SOP</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label">Nama Layanan</label>
                      <input type="text" class="form-control" id="inputJudul" placeholder="Cth: Izin Stasiun Radio (ISR)">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Deskripsi Singkat</label>
                      <textarea class="form-control" id="inputDeskripsi" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Upload File (PDF/Gambar)</label>
                      <input type="file" class="form-control" id="inputFile">
                      <div class="form-text">Maksimal 2MB.</div>
                    </div>
                    <div class="d-grid gap-2">
                      <button onclick="simpanData()" class="btn btn-primary"><i class="bi bi-save"></i> Simpan & Publikasi</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-lg-7">
                
                <div class="card mb-4">
                  <div class="card-header border-0">
                    <h3 class="card-title">Daftar Layanan Terpublikasi</h3>
                  </div>
                  <div class="card-body table-responsive p-0">
                    <table class="table table-striped align-middle">
                      <thead>
                        <tr>
                          <th>Layanan</th>
                          <th>File</th>
                          <th style="width: 40px">Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="tabelLayanan">
                        <tr><td colspan="3" class="text-center">Memuat data...</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="card border-danger mb-4">
                  <div class="card-header bg-danger text-white">
                    <h3 class="card-title"><i class="bi bi-bell-fill"></i> Pengaduan Masyarakat Terbaru</h3>
                  </div>
                  <div class="card-body p-0 table-responsive">
                    <table class="table table-sm table-hover">
                      <thead>
                        <tr>
                          <th>Pelapor</th>
                          <th>Masalah</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="tabelPengaduan">
                        </tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>
      </main>
      
      <footer class="app-footer">
        <strong>Copyright &copy; 2025 Balmon Samarinda.</strong>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta2/dist/js/adminlte.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
      // ----------------------------------------------------
      // 1. KONFIGURASI FIREBASE ANDA (SUDAH DIPASANG)
      // ----------------------------------------------------
      const firebaseConfig = {
        apiKey: "AIzaSyDUeIg9Zn_xndPXtChO8KufXFp6EMtqBJ0",
        authDomain: "admin-pelayanan-balmon.firebaseapp.com",
        databaseURL: "https://admin-pelayanan-balmon-default-rtdb.firebaseio.com",
        projectId: "admin-pelayanan-balmon",
        storageBucket: "admin-pelayanan-balmon.firebasestorage.app", // Perbaikan domain bucket
        messagingSenderId: "1071557110255",
        appId: "1:1071557110255:web:bff7087da1feacccb7ee1a",
        measurementId: "G-V19CNH48LK"
      };

      // Inisialisasi Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.database();
      const storage = firebase.storage();

      // ----------------------------------------------------
      // 2. LOGIKA UPLOAD & SIMPAN LAYANAN
      // ----------------------------------------------------
      async function simpanData() {
        const judul = document.getElementById('inputJudul').value;
        const desk = document.getElementById('inputDeskripsi').value;
        const file = document.getElementById('inputFile').files[0];

        if (!judul) return Swal.fire('Error', 'Nama Layanan wajib diisi', 'error');

        Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });

        try {
          let fileUrl = "";
          if (file) {
            // Upload ke Firebase Storage
            const ref = storage.ref(`dokumen_layanan/${Date.now()}_${file.name}`);
            const snapshot = await ref.put(file);
            fileUrl = await snapshot.ref.getDownloadURL();
          }

          // Simpan ke Realtime Database
          await db.ref('layanan_publik').push({
            judul: judul,
            deskripsi: desk,
            file_url: fileUrl,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });

          Swal.fire('Berhasil', 'Layanan berhasil ditambahkan!', 'success');
          // Reset Form
          document.getElementById('inputJudul').value = '';
          document.getElementById('inputDeskripsi').value = '';
          document.getElementById('inputFile').value = '';
        } catch (e) {
          console.error(e);
          Swal.fire('Gagal', e.message, 'error');
        }
      }

      // ----------------------------------------------------
      // 3. MENAMPILKAN DATA LAYANAN (REALTIME)
      // ----------------------------------------------------
      db.ref('layanan_publik').on('value', snap => {
        const tbody = document.getElementById('tabelLayanan');
        tbody.innerHTML = '';
        let total = 0;

        snap.forEach(child => {
          total++;
          const data = child.val();
          const btnFile = data.file_url 
            ? `<a href="${data.file_url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Unduh</a>`
            : '<span class="badge text-bg-secondary">Tanpa File</span>';

          tbody.innerHTML += `
            <tr>
              <td>
                <span class="fw-bold">${data.judul}</span><br>
                <small class="text-muted">${data.deskripsi || ''}</small>
              </td>
              <td>${btnFile}</td>
              <td>
                <button onclick="hapusLayanan('${child.key}')" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
              </td>
            </tr>
          `;
        });
        document.getElementById('stat-layanan').innerText = total;
      });

      // ----------------------------------------------------
      // 4. MONITOR PENGADUAN MASYARAKAT (REALTIME)
      // ----------------------------------------------------
      db.ref('pengaduan_masyarakat').limitToLast(10).on('value', snap => {
        const tbody = document.getElementById('tabelPengaduan');
        tbody.innerHTML = '';
        let count = 0;
        
        let arr = [];
        snap.forEach(c => arr.push({k: c.key, v: c.val()}));
        
        arr.reverse().forEach(item => {
          count++;
          const d = item.v;
          
          // Warna status otomatis
          let badge = 'text-bg-secondary';
          if (d.status === 'Selesai') badge = 'text-bg-success';
          else if (d.status === 'Proses') badge = 'text-bg-primary';
          else badge = 'text-bg-warning';

          tbody.innerHTML += `
            <tr>
              <td>
                 <span class="fw-bold">${d.nama_pelapor || 'Anonim'}</span><br>
                 <small class="text-muted"><i class="bi bi-geo-alt"></i> ${d.lokasi || '-'}</small>
              </td>
              <td>
                 <span class="text-danger fw-bold">${d.kategori}</span><br> 
                 <small>${d.deskripsi}</small>
              </td>
              <td>
                <span class="badge ${badge} mb-1">${d.status}</span><br>
                <button onclick="updateStatus('${item.k}')" class="btn btn-xs btn-light border btn-sm py-0">Ubah</button>
              </td>
            </tr>
          `;
        });
        document.getElementById('stat-aduan').innerText = count;
      });

      // ----------------------------------------------------
      // 5. FITUR HAPUS & UPDATE
      // ----------------------------------------------------
      function hapusLayanan(key) {
        Swal.fire({
          title: 'Hapus Layanan ini?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Hapus'
        }).then(res => {
          if(res.isConfirmed) db.ref(`layanan_publik/${key}`).remove();
        });
      }

      function updateStatus(key) {
        Swal.fire({
          title: 'Update Status Laporan',
          input: 'select',
          inputOptions: {
            'Menunggu': 'Menunggu',
            'Proses': 'Sedang Diproses',
            'Selesai': 'Selesai'
          },
          showCancelButton: true
        }).then(res => {
          if(res.isConfirmed) {
            db.ref(`pengaduan_masyarakat/${key}`).update({ status: res.value });
            Swal.fire('Tersimpan', '', 'success');
          }
        });
      }

    </script>
  </body>
</html>